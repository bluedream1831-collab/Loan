<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æº«é¦¨ç†è²¡ï½œå…¨æ–¹ä½è²¸æ¬¾è¨ˆç®—æ©Ÿ - WUCJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', '"Microsoft JhengHei"', 'sans-serif'], },
                    colors: {
                        cream: '#FFFBF5',
                        warm: { 50: '#FAF7F2', 100: '#F5EFE6', 200: '#E6DCC9', 500: '#B89F7D', 600: '#8C7051', 800: '#5D4037' },
                        accent: { house: '#D97706', credit: '#65A30D', car: '#EA580C' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FFFBF5; color: #5D4037; }
        
        .btn-warm { background-color: #D97706; color: white; padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.2); }
        .btn-warm:hover { background-color: #B45309; transform: translateY(-1px); }
        .btn-soft { background-color: #FFF; border: 2px solid #E6DCC9; color: #8C7051; padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.3s; cursor: pointer; }
        .btn-soft:hover, .btn-soft.active { background-color: #F5EFE6; border-color: #B89F7D; color: #5D4037; font-weight: bold; }
        .input-warm { background-color: #FFF; border: 1px solid #E6DCC9; border-radius: 0.75rem; padding: 0.5rem; width: 100%; color: #5D4037; transition: border-color 0.3s; }
        .input-warm:focus { outline: none; border-color: #D97706; ring: 2px solid #FEF3C7; }
        .card-warm { background-color: white; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(93, 64, 55, 0.05); border: 1px solid #F5EFE6; }

        /* åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .card-warm { box-shadow: none; border: 1px solid #eee; margin-bottom: 20px; page-break-inside: avoid; }
            
            /* å¼·åˆ¶æ¯ä¸€é è¡¨æ ¼å€å¡Šåˆ†é  */
            .table-page { display: block !important; page-break-before: always; margin-top: 20px; }
            .table-page:first-of-type { page-break-before: auto; } /* ç¬¬ä¸€é ä¸å¼·åˆ¶æ›é  */
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 min-h-screen">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="max-w-7xl mx-auto flex justify-between items-center mb-8 no-print pt-2">
        <div class="flex items-center gap-3">
            <div class="bg-orange-100 p-2 rounded-full text-2xl">ğŸ¡</div>
            <h1 class="text-2xl font-bold text-warm-800 tracking-wider">è²¸æ¬¾è¨ˆç®—æ©Ÿ</h1>
        </div>
        <a href="https://vocus.cc/user/@WUCJ" target="_blank" class="flex items-center gap-2 text-warm-600 hover:text-accent-house transition font-medium text-sm sm:text-base">
            <img src="https://ui-avatars.com/api/?name=WUCJ&background=B45309&color=fff" class="w-8 h-8 rounded-full shadow-sm">
            <span>è¿½è¹¤ WUCJ</span>
        </a>
    </nav>

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- å·¥å…·åˆ— -->
        <div class="flex flex-wrap justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-warm-100 no-print">
            <div class="flex flex-wrap gap-2 mb-2 sm:mb-0">
                <button onclick="document.getElementById('importFile').click()" class="btn-soft text-sm"><i class="fas fa-folder-open"></i> è®€å–èˆŠæª”</button>
                <button onclick="exportData()" class="btn-soft text-sm"><i class="fas fa-save"></i> å„²å­˜è¨­å®š</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
            </div>
            <button onclick="window.print()" class="btn-warm text-sm font-bold flex items-center gap-2">
                <i class="fas fa-print"></i> ä¸€éµåˆ—å° / å¦å­˜ PDF
            </button>
        </div>

        <!-- åˆ—å°æ¨™é ­ -->
        <div class="hidden print-only text-center mb-8 border-b-2 border-warm-200 pb-4">
            <h1 class="text-3xl font-bold text-warm-800">å€‹äººè²¡å‹™è²¸æ¬¾è©¦ç®—å ±å‘Š</h1>
            <p class="text-warm-600 mt-1">Generated by WUCJ è²¸æ¬¾è¨ˆç®—æ©Ÿ</p>
        </div>

        <!-- è¼¸å…¥å€å¡Š -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 no-print">
            
            <!-- æˆ¿è²¸ -->
            <div class="card-warm p-6 border-t-4 border-amber-500 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-amber-50 opacity-50 text-9xl pointer-events-none rotate-12"><i class="fas fa-home"></i></div>
                <h3 class="font-bold text-lg mb-5 text-warm-800 flex items-center"><span class="w-2 h-8 bg-amber-500 rounded-full mr-3"></span>æˆ¿å±‹è²¸æ¬¾</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="h-amt" class="input-warm" value="1000"></div>
                    <div class="flex gap-4">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="h-rate" class="input-warm" value="2.1" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="h-year" class="input-warm" value="30"></div>
                    </div>
                    <div><label class="text-xs text-warm-600 ml-1">å¯¬é™æœŸ (å¹´)</label><input type="number" id="h-grace" class="input-warm bg-orange-50" value="0"></div>
                </div>
            </div>

            <!-- ä¿¡è²¸ -->
            <div class="card-warm p-6 border-t-4 border-lime-600 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-lime-50 opacity-50 text-9xl pointer-events-none rotate-12"><i class="fas fa-coins"></i></div>
                <h3 class="font-bold text-lg mb-5 text-warm-800 flex items-center"><span class="w-2 h-8 bg-lime-600 rounded-full mr-3"></span>ä¿¡ç”¨è²¸æ¬¾</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="p-amt" class="input-warm" value="0"></div>
                    <div class="flex gap-4">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="p-rate" class="input-warm" value="3.5" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="p-year" class="input-warm" value="7"></div>
                    </div>
                </div>
            </div>

            <!-- è»Šè²¸ -->
            <div class="card-warm p-6 border-t-4 border-orange-600 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-orange-50 opacity-50 text-9xl pointer-events-none rotate-12"><i class="fas fa-car-side"></i></div>
                <h3 class="font-bold text-lg mb-5 text-warm-800 flex items-center"><span class="w-2 h-8 bg-orange-600 rounded-full mr-3"></span>æ±½è»Šè²¸æ¬¾</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="c-amt" class="input-warm" value="0"></div>
                    <div class="flex gap-4">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="c-rate" class="input-warm" value="4.0" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="c-year" class="input-warm" value="5"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨å±€è¨­å®š (é–‹å§‹æ™‚é–“ + æ”¶å…¥) -->
        <div class="card-warm p-6 bg-warm-50 border border-warm-200 no-print">
            <div class="flex flex-col md:flex-row items-end gap-6">
                <div class="w-full md:w-1/3">
                    <label class="font-bold text-warm-800 text-sm"><i class="fas fa-calendar-alt mr-2"></i>é–‹å§‹é‚„æ¬¾æœˆä»½</label>
                    <input type="month" id="start-month" class="input-warm mt-1" onchange="calculateAll()">
                </div>
                <div class="w-full md:w-1/3">
                    <label class="font-bold text-warm-800 text-sm"><i class="fas fa-wallet mr-2"></i>æœˆæ”¶å…¥ (å…ƒ)</label>
                    <input type="number" id="income" class="input-warm mt-1" value="60000">
                </div>
                <div class="w-full md:w-1/3">
                    <div id="dti-msg" class="hidden text-rose-600 text-sm font-bold"><i class="fas fa-exclamation-triangle"></i> è² å‚µæ¯”éé«˜ (>60%)</div>
                    <div id="dti-ok" class="hidden text-green-700 text-sm font-bold"><i class="fas fa-check-circle"></i> è²¡å‹™ç‹€æ³å¥åº·</div>
                </div>
            </div>
        </div>

        <!-- å ±è¡¨ç¸½è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card-warm p-6 flex flex-col items-center justify-center">
                <h4 class="text-warm-600 font-bold mb-4">æœˆä»˜é‡‘çµæ§‹</h4>
                <div class="w-40 h-40 relative">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="md:col-span-2 card-warm p-6">
                <h4 class="text-warm-600 font-bold mb-4 border-b border-warm-100 pb-2">è²¡å‹™é æ¸¬æ‘˜è¦</h4>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-6">
                    <div class="p-3 bg-orange-50 rounded-xl"><div class="text-xs text-warm-500">é¦–æœˆæ”¯å‡º</div><div class="text-lg font-bold text-accent-house" id="res-monthly">$0</div></div>
                    <div class="p-3 bg-stone-50 rounded-xl"><div class="text-xs text-warm-500">æ¯å¹´æ”¯å‡º</div><div class="text-lg font-bold text-warm-800" id="res-yearly">$0</div></div>
                    <div class="p-3 bg-stone-50 rounded-xl"><div class="text-xs text-warm-500">ç¸½åˆ©æ¯</div><div class="text-lg font-bold text-warm-600" id="res-interest">$0</div></div>
                    <div class="p-3 bg-lime-50 rounded-xl"><div class="text-xs text-warm-500">è² å‚µæ¯”</div><div class="text-lg font-bold text-accent-credit" id="res-dti">0%</div></div>
                </div>
                <div class="h-40"><canvas id="scheduleChart"></canvas></div>
            </div>
        </div>

        <!-- è©³ç´°è¡¨æ ¼å€ (åŒ…å«åˆ†é é‚è¼¯) -->
        <div id="schedule-container">
            <!-- JS å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆè¡¨æ ¼ -->
        </div>

        <!-- é å°¾ -->
        <footer class="text-center text-warm-500 text-sm py-8 print-only-footer">
            <p class="mb-2">ç†è²¡è¦åŠƒãƒ»è²¸æ¬¾è©¦ç®—</p>
            <a href="https://vocus.cc/user/@WUCJ" target="_blank" class="inline-block px-4 py-2 rounded-full bg-white border border-warm-200 hover:bg-warm-50 transition">
                æ›´å¤šæ–‡ç« è«‹è‡³ <strong class="text-accent-house">WUCJ çš„æ–¹æ ¼å­</strong>
            </a>
            <p class="text-xs mt-4 opacity-60">è¨ˆç®—çµæœåƒ…ä¾›åƒè€ƒã€‚</p>
        </footer>
    </div>

    <script>
        // è¨­å®šé è¨­æœˆä»½ç‚ºä¸‹å€‹æœˆ
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        document.getElementById('start-month').value = nextMonth.toISOString().slice(0, 7);

        let scheduleChart, pieChart;
        const fmt = (n) => Math.round(n).toLocaleString();

        // è²¸æ¬¾é¡åˆ¥
        class Loan {
            constructor(amountWan, rate, years, graceYears = 0) {
                this.principal = amountWan * 10000;
                this.rate = rate / 100 / 12;
                this.periods = years * 12;
                this.gracePeriods = graceYears * 12;
            }
            getSchedule() {
                let schedule = [];
                let balance = this.principal;
                let amortizePeriods = this.periods - this.gracePeriods;
                let pmt = (amortizePeriods > 0 && this.rate > 0) 
                    ? (this.principal * this.rate * Math.pow(1 + this.rate, amortizePeriods)) / (Math.pow(1 + this.rate, amortizePeriods) - 1)
                    : (amortizePeriods > 0 ? this.principal / amortizePeriods : 0);

                for (let i = 1; i <= this.periods; i++) {
                    let interest = balance * this.rate;
                    let payment = (i <= this.gracePeriods) ? interest : pmt;
                    let principalPaid = payment - interest;
                    if (i > this.gracePeriods && balance - principalPaid < 10) { principalPaid = balance; payment = principalPaid + interest; }
                    balance -= principalPaid; if (balance < 0) balance = 0;
                    schedule.push({ month: i, payment, interest, principal: principalPaid, balance });
                }
                return schedule;
            }
        }

        function calculateAll() {
            // å–å¾—è¼¸å…¥
            const inputs = {
                h: { amt: +document.getElementById('h-amt').value, rate: +document.getElementById('h-rate').value, yr: +document.getElementById('h-year').value, grace: +document.getElementById('h-grace').value },
                p: { amt: +document.getElementById('p-amt').value, rate: +document.getElementById('p-rate').value, yr: +document.getElementById('p-year').value },
                c: { amt: +document.getElementById('c-amt').value, rate: +document.getElementById('c-rate').value, yr: +document.getElementById('c-year').value },
                income: +document.getElementById('income').value,
                startMonth: document.getElementById('start-month').value
            };

            const sH = new Loan(inputs.h.amt, inputs.h.rate, inputs.h.yr, inputs.h.grace).getSchedule();
            const sP = new Loan(inputs.p.amt, inputs.p.rate, inputs.p.yr).getSchedule();
            const sC = new Loan(inputs.c.amt, inputs.c.rate, inputs.c.yr).getSchedule();

            const maxMonths = Math.max(sH.length, sP.length, sC.length);
            let combined = [];
            let totalInterest = 0;

            // æ—¥æœŸè¨ˆç®—åŸºç¤
            let [startYear, startM] = inputs.startMonth.split('-').map(Number);
            startM -= 1; // JSæœˆä»½å¾0é–‹å§‹

            for (let i = 0; i < maxMonths; i++) {
                const h = sH[i] || { payment: 0, interest: 0, principal: 0, balance: 0 };
                const p = sP[i] || { payment: 0, interest: 0, principal: 0, balance: 0 };
                const c = sC[i] || { payment: 0, interest: 0, principal: 0, balance: 0 };

                // è¨ˆç®—ç•¶å‰è¡Œæ—¥æœŸ
                let currentD = new Date(startYear, startM + i, 1);
                let dateStr = `${currentD.getFullYear()} / ${(currentD.getMonth() + 1).toString().padStart(2, '0')}`;

                let rowPay = h.payment + p.payment + c.payment;
                let rowInt = h.interest + p.interest + c.interest;
                let rowPrin = h.principal + p.principal + c.principal;
                let rowBal = h.balance + p.balance + c.balance;

                totalInterest += rowInt;
                combined.push({ idx: i+1, date: dateStr, payment: rowPay, interest: rowInt, principal: rowPrin, balance: rowBal });
            }

            updateDashboard(combined, totalInterest, inputs.income, (sH[0]?.payment||0), (sP[0]?.payment||0), (sC[0]?.payment||0));
            renderPagedTable(combined);
            updateCharts(combined, (sH[0]?.payment||0), (sP[0]?.payment||0), (sC[0]?.payment||0));
        }

        function updateDashboard(data, totalInt, income, h, p, c) {
            const first = data[0]?.payment || 0;
            document.getElementById('res-monthly').innerText = '$' + fmt(first);
            document.getElementById('res-yearly').innerText = '$' + fmt(first * 12);
            document.getElementById('res-interest').innerText = '$' + fmt(totalInt);
            
            const dti = income > 0 ? (first / income * 100) : 0;
            const dtiEl = document.getElementById('res-dti');
            dtiEl.innerText = dti.toFixed(1) + '%';
            
            if(dti > 60) {
                document.getElementById('dti-msg').classList.remove('hidden');
                document.getElementById('dti-ok').classList.add('hidden');
                dtiEl.classList.add('text-rose-600');
            } else {
                document.getElementById('dti-msg').classList.add('hidden');
                document.getElementById('dti-ok').classList.remove('hidden');
                dtiEl.classList.remove('text-rose-600');
            }
        }

        // --- æ ¸å¿ƒï¼šåˆ†é è¡¨æ ¼æ¸²æŸ“ ---
        function renderPagedTable(data) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = ''; // æ¸…ç©º

            const pageSize = 120; // 10å¹´ä¸€é 
            const totalPages = Math.ceil(data.length / pageSize);
            
            // 1. å»ºç«‹åˆ†é æŒ‰éˆ•å€ (åƒ…è¢å¹•é¡¯ç¤º)
            if (totalPages > 1) {
                const tabContainer = document.createElement('div');
                tabContainer.className = 'flex gap-2 mb-4 overflow-x-auto pb-2 no-print';
                for (let i = 0; i < totalPages; i++) {
                    const btn = document.createElement('button');
                    const startY = i * 10 + 1;
                    const endY = Math.min((i + 1) * 10, Math.ceil(data.length/12));
                    btn.className = `btn-soft text-xs whitespace-nowrap ${i === 0 ? 'active' : ''}`;
                    btn.innerHTML = `ç¬¬ ${startY}-${endY} å¹´`;
                    btn.onclick = () => switchTab(i);
                    tabContainer.appendChild(btn);
                }
                container.appendChild(tabContainer);
            }

            // 2. å»ºç«‹å„é è¡¨æ ¼
            for (let i = 0; i < totalPages; i++) {
                const pageData = data.slice(i * pageSize, (i + 1) * pageSize);
                
                // å¤–å±¤å®¹å™¨ (ç”¨æ–¼æ§åˆ¶é¡¯ç¤º/éš±è— å’Œ åˆ—å°åˆ†é )
                const pageDiv = document.createElement('div');
                pageDiv.className = `table-page card-warm overflow-hidden ${i === 0 ? '' : 'hidden'}`;
                pageDiv.id = `page-${i}`;

                // æ¨™é¡Œ
                const header = document.createElement('div');
                header.className = 'p-4 bg-warm-100 border-b border-warm-200 flex justify-between items-center';
                const startY = i * 10 + 1;
                const endY = Math.min((i + 1) * 10, Math.ceil(data.length/12));
                header.innerHTML = `<h3 class="font-bold text-warm-800"><i class="fas fa-calendar-week mr-2"></i>é‚„æ¬¾æ˜ç´° (ç¬¬ ${startY} - ${endY} å¹´)</h3>`;
                pageDiv.appendChild(header);

                // è¡¨æ ¼æœ¬é«”
                const tableWrap = document.createElement('div');
                tableWrap.className = 'overflow-x-auto';
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left';
                table.innerHTML = `
                    <thead class="bg-warm-50 text-warm-600">
                        <tr>
                            <th class="p-3 pl-6">æœŸæ•¸</th>
                            <th class="p-3">æœˆä»½</th>
                            <th class="p-3 text-right">æœ¬æœˆæ‡‰ç¹³</th>
                            <th class="p-3 text-right text-warm-400">åˆ©æ¯</th>
                            <th class="p-3 text-right text-warm-400">æœ¬é‡‘</th>
                            <th class="p-3 text-right pr-6">å‰©é¤˜æœ¬é‡‘</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-warm-100 text-warm-700">
                        ${pageData.map(row => `
                            <tr class="hover:bg-orange-50 transition">
                                <td class="p-3 pl-6">${row.idx}</td>
                                <td class="p-3 text-warm-800 font-mono">${row.date}</td>
                                <td class="p-3 text-right font-bold">$${fmt(row.payment)}</td>
                                <td class="p-3 text-right text-xs text-warm-500">$${fmt(row.interest)}</td>
                                <td class="p-3 text-right text-xs text-warm-500">$${fmt(row.principal)}</td>
                                <td class="p-3 text-right pr-6 text-warm-400">$${fmt(row.balance)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                tableWrap.appendChild(table);
                pageDiv.appendChild(tableWrap);
                container.appendChild(pageDiv);
            }
        }

        // åˆ‡æ›åˆ†é ç±¤
        function switchTab(index) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const btns = document.querySelectorAll('.btn-soft');
            btns.forEach((btn, idx) => {
                if (idx === index + 2) { // +2 æ˜¯å› ç‚ºå‰é¢æœ‰å…©å€‹å›ºå®šæŒ‰éˆ•(è®€å–/åŒ¯å‡º) ä¿®æ­£: é€™è£¡æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œé¸æ“‡å™¨è¦ç²¾æº–
                   // é€™è£¡ç°¡åŒ–ï¼šç›´æ¥æ“ä½œ class
                }
            });
            // ç”±æ–¼ btn-soft é¡åˆ¥ä¹Ÿç”¨æ–¼é ‚éƒ¨æŒ‰éˆ•ï¼Œæˆ‘å€‘æ”¹ç”¨ id æˆ–çˆ¶å±¤æŸ¥æ‰¾è¼ƒå®‰å…¨ï¼Œä½†é€™é‚Šç”¨ç°¡å–®çš„éæ­·é¡¯ç¤ºéš±è—
            const pages = document.querySelectorAll('.table-page');
            pages.forEach((page, idx) => {
                if (idx === index) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            const tabContainer = document.querySelector('#schedule-container > div.flex');
            if(tabContainer) {
                Array.from(tabContainer.children).forEach((btn, idx) => {
                    if(idx === index) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }
        }

        function updateCharts(data, h, p, c) {
            let labels = [], dataset = [];
            for(let i=0; i<data.length; i+=12) {
                labels.push(`ç¬¬${Math.ceil((i+1)/12)}å¹´`);
                dataset.push(data[i].payment);
            }
            if(scheduleChart) scheduleChart.destroy();
            if(pieChart) pieChart.destroy();

            const ctxLine = document.getElementById('scheduleChart').getContext('2d');
            scheduleChart = new Chart(ctxLine, {
                type: 'line',
                data: { labels, datasets: [{ label: 'æœˆæ”¯å‡º', data: dataset, borderColor: '#8C7051', backgroundColor: 'rgba(140, 112, 81, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });

            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: ['æˆ¿è²¸', 'ä¿¡è²¸', 'è»Šè²¸'], datasets: [{ data: [h, p, c], backgroundColor: ['#D97706', '#65A30D', '#EA580C'], borderWidth: 0 }] },
                options: { cutout: '60%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function exportData() {
            const data = {
                h: { amt: document.getElementById('h-amt').value, rate: document.getElementById('h-rate').value, yr: document.getElementById('h-year').value, grace: document.getElementById('h-grace').value },
                p: { amt: document.getElementById('p-amt').value, rate: document.getElementById('p-rate').value, yr: document.getElementById('p-year').value },
                c: { amt: document.getElementById('c-amt').value, rate: document.getElementById('c-rate').value, yr: document.getElementById('c-year').value },
                income: document.getElementById('income').value,
                startMonth: document.getElementById('start-month').value
            };
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
            a.download = "loan_config_wucj.json"; a.click();
        }

        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    document.getElementById('h-amt').value = d.h.amt; document.getElementById('h-rate').value = d.h.rate; document.getElementById('h-year').value = d.h.yr; document.getElementById('h-grace').value = d.h.grace;
                    document.getElementById('p-amt').value = d.p.amt; document.getElementById('p-rate').value = d.p.rate; document.getElementById('p-year').value = d.p.yr;
                    document.getElementById('c-amt').value = d.c.amt; document.getElementById('c-rate').value = d.c.rate; document.getElementById('c-year').value = d.c.yr;
                    document.getElementById('income').value = d.income; document.getElementById('start-month').value = d.startMonth;
                    calculateAll();
                } catch(err) {}
            }; r.readAsText(file);
        }

        document.querySelectorAll('input').forEach(el => el.addEventListener('input', calculateAll));
        window.onload = calculateAll;
    </script>
</body>
</html>
