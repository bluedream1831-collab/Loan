<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æº«é¦¨ç†è²¡ï½œé›™æˆ¿è²¸è©¦ç®—è¨ˆç®—æ©Ÿ - WUCJ</title>
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', '"Microsoft JhengHei"', 'sans-serif'], },
                    colors: {
                        cream: '#FFFBF5',
                        warm: { 50: '#FAF7F2', 100: '#F5EFE6', 200: '#E6DCC9', 500: '#B89F7D', 600: '#8C7051', 800: '#5D4037' },
                        accent: { 
                            house1: '#D97706', // æˆ¿è²¸A (ç¥ç€)
                            house2: '#9333EA', // æˆ¿è²¸B (ç´«è‰²-å¢è²¸)
                            credit: '#65A30D', // ä¿¡è²¸ (ç¶ è‰²)
                            car: '#EA580C'     // è»Šè²¸ (æ©˜è‰²)
                        }
                    },
                    screens: { 'print': {'raw': 'print'} }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FFFBF5; color: #5D4037; -webkit-tap-highlight-color: transparent; }
        
        /* å…ƒä»¶æ¨£å¼ */
        .btn-warm { background-color: #D97706; color: white; padding: 0.75rem 1.25rem; border-radius: 9999px; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.2); font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-warm:active { transform: scale(0.95); background-color: #B45309; }
        .btn-soft { background-color: #FFF; border: 2px solid #E6DCC9; color: #8C7051; padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.2s; white-space: nowrap; }
        .btn-soft:active, .btn-soft.active { background-color: #F5EFE6; border-color: #B89F7D; color: #5D4037; font-weight: bold; }
        .input-warm { background-color: #FFF; border: 1px solid #E6DCC9; border-radius: 0.75rem; padding: 0.75rem; width: 100%; color: #5D4037; font-size: 16px; }
        .input-warm:focus { outline: none; border-color: #D97706; ring: 2px solid #FEF3C7; }
        .card-warm { background-color: white; border-radius: 1.25rem; box-shadow: 0 4px 20px -5px rgba(93, 64, 55, 0.08); border: 1px solid #F5EFE6; }

        /* Modal & Print */
        #help-modal { backdrop-filter: blur(4px); background-color: rgba(93, 64, 55, 0.3); }
        #share-card-canvas { width: 1080px; height: 1080px; position: fixed; left: -9999px; top: 0; background: #FFFBF5; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 80px; fontFamily: "Zen Maru Gothic", sans-serif; }
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .card-warm { box-shadow: none; border: 1px solid #ccc; margin-bottom: 20px; page-break-inside: avoid; }
            .table-page { display: block !important; page-break-before: always; margin-top: 20px; }
            .table-page:first-of-type { page-break-before: auto; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center mb-6 no-print gap-4">
        <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
            <div class="flex items-center gap-3">
                <div class="bg-orange-100 p-2 rounded-full text-2xl shadow-sm">ğŸ¡</div>
                <h1 class="text-2xl font-bold text-warm-800 tracking-wider">é›™æˆ¿è²¸è¨ˆç®—æ©Ÿ</h1>
            </div>
            <button onclick="toggleHelp()" class="sm:hidden text-warm-600 bg-white border border-warm-200 px-3 py-1 rounded-full text-sm font-bold shadow-sm"><i class="fas fa-book-open"></i> èªªæ˜</button>
        </div>
        <div class="flex items-center gap-3">
            <span id="auto-save-toast" class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full opacity-0 transition-opacity"><i class="fas fa-check"></i> å·²è‡ªå‹•å„²å­˜</span>
            <button onclick="toggleHelp()" class="hidden sm:flex items-center gap-2 text-warm-600 bg-white border border-warm-200 px-3 py-1 rounded-full text-sm font-bold shadow-sm hover:bg-warm-50 transition"><i class="fas fa-book-open"></i> ä½¿ç”¨èªªæ˜</button>
            <a href="https://vocus.cc/user/@WUCJ" target="_blank" class="flex items-center gap-2 text-warm-600 hover:text-accent-house1 transition font-medium bg-white px-4 py-2 rounded-full shadow-sm border border-warm-100"><img src="https://ui-avatars.com/api/?name=WUCJ&background=B45309&color=fff" class="w-6 h-6 rounded-full"><span>è¿½è¹¤ WUCJ</span></a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- å·¥å…·åˆ— -->
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-warm-100 no-print">
            <div class="flex flex-col sm:flex-row gap-3 justify-between items-center">
                <div class="flex gap-2 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0">
                    <button onclick="document.getElementById('importFile').click()" class="btn-soft text-sm"><i class="fas fa-file-import"></i> è®€å–</button>
                    <button onclick="exportData()" class="btn-soft text-sm"><i class="fas fa-file-export"></i> å‚™ä»½</button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="generateShareCard()" class="btn-warm flex-1 sm:flex-none text-sm bg-gradient-to-r from-purple-500 to-pink-500 border-none"><i class="fab fa-instagram"></i> ç”Ÿæˆåˆ†äº«å¡</button>
                    <button onclick="window.print()" class="btn-warm flex-1 sm:flex-none text-sm"><i class="fas fa-print"></i> åˆ—å° / PDF</button>
                </div>
            </div>
        </div>

        <!-- åˆ—å°æ¨™é ­ -->
        <div class="hidden print-only text-center mb-8 border-b-2 border-warm-200 pb-4">
            <h1 class="text-3xl font-bold text-warm-800">å€‹äººè²¡å‹™è²¸æ¬¾è©¦ç®—å ±å‘Š (è½‰å¢è²¸ç‰ˆ)</h1>
            <p class="text-warm-600 mt-1">Generated by WUCJ è²¸æ¬¾è¨ˆç®—æ©Ÿ</p>
        </div>

        <!-- è¼¸å…¥å€å¡Š (2x2 ä½ˆå±€) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 no-print">
            
            <!-- æˆ¿è²¸ A (ä¸»è²¸æ¬¾) -->
            <div class="card-warm p-5 border-t-4 border-amber-500 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-amber-50 opacity-20 text-9xl pointer-events-none rotate-12"><i class="fas fa-home"></i></div>
                <h3 class="font-bold text-lg mb-4 text-warm-800 flex items-center"><span class="w-2 h-6 bg-amber-500 rounded-full mr-2"></span>æˆ¿è²¸ A (ä¸»ç´„)</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="h-amt" class="input-warm" value="1000"></div>
                    <div class="flex gap-3">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="h-rate" class="input-warm" value="2.1" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="h-year" class="input-warm" value="30"></div>
                    </div>
                    <!-- æå‰é‚„æ¬¾ A -->
                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100">
                        <div class="flex items-center justify-between mb-2 cursor-pointer" onclick="togglePrepay('a')">
                            <label class="text-xs font-bold text-amber-800 flex items-center"><i class="fas fa-piggy-bank mr-1"></i> A æå‰é‚„æ¬¾è©¦ç®—</label>
                            <i class="fas fa-chevron-down text-amber-800 text-xs" id="prepay-icon-a"></i>
                        </div>
                        <div id="prepay-box-a" class="hidden space-y-3">
                            <div class="flex gap-3">
                                <div class="w-1/2"><label class="text-[10px] text-amber-700">ç¬¬å¹¾å¹´é‚„</label><input type="number" id="h-pre-yr" class="input-warm text-sm p-2" placeholder="Ex: 5"></div>
                                <div class="w-1/2"><label class="text-[10px] text-amber-700">é‡‘é¡(è¬)</label><input type="number" id="h-pre-amt" class="input-warm text-sm p-2" placeholder="Ex: 50"></div>
                            </div>
                        </div>
                    </div>
                    <div><label class="text-xs text-warm-600 ml-1">å¯¬é™æœŸ (å¹´)</label><input type="number" id="h-grace" class="input-warm bg-orange-50" value="0"></div>
                </div>
            </div>

            <!-- æˆ¿è²¸ B (å¢è²¸/äºŒèƒ) -->
            <div class="card-warm p-5 border-t-4 border-purple-500 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-purple-50 opacity-20 text-9xl pointer-events-none rotate-12"><i class="fas fa-building"></i></div>
                <h3 class="font-bold text-lg mb-4 text-warm-800 flex items-center"><span class="w-2 h-6 bg-purple-500 rounded-full mr-2"></span>æˆ¿è²¸ B (å¢è²¸/äºŒèƒ)</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="h2-amt" class="input-warm" value="0"></div>
                    <div class="flex gap-3">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="h2-rate" class="input-warm" value="2.5" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="h2-year" class="input-warm" value="20"></div>
                    </div>
                    <!-- æå‰é‚„æ¬¾ B -->
                    <div class="bg-purple-50 p-3 rounded-xl border border-purple-100">
                        <div class="flex items-center justify-between mb-2 cursor-pointer" onclick="togglePrepay('b')">
                            <label class="text-xs font-bold text-purple-800 flex items-center"><i class="fas fa-piggy-bank mr-1"></i> B æå‰é‚„æ¬¾è©¦ç®—</label>
                            <i class="fas fa-chevron-down text-purple-800 text-xs" id="prepay-icon-b"></i>
                        </div>
                        <div id="prepay-box-b" class="hidden space-y-3">
                            <div class="flex gap-3">
                                <div class="w-1/2"><label class="text-[10px] text-purple-700">ç¬¬å¹¾å¹´é‚„</label><input type="number" id="h2-pre-yr" class="input-warm text-sm p-2" placeholder="Ex: 3"></div>
                                <div class="w-1/2"><label class="text-[10px] text-purple-700">é‡‘é¡(è¬)</label><input type="number" id="h2-pre-amt" class="input-warm text-sm p-2" placeholder="Ex: 30"></div>
                            </div>
                        </div>
                    </div>
                    <div><label class="text-xs text-warm-600 ml-1">å¯¬é™æœŸ (å¹´)</label><input type="number" id="h2-grace" class="input-warm bg-purple-50" value="0"></div>
                </div>
            </div>

            <!-- ä¿¡è²¸ -->
            <div class="card-warm p-5 border-t-4 border-lime-600 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-lime-50 opacity-20 text-9xl pointer-events-none rotate-12"><i class="fas fa-coins"></i></div>
                <h3 class="font-bold text-lg mb-4 text-warm-800 flex items-center"><span class="w-2 h-6 bg-lime-600 rounded-full mr-2"></span>ä¿¡ç”¨è²¸æ¬¾</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="p-amt" class="input-warm" value="0"></div>
                    <div class="flex gap-3">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="p-rate" class="input-warm" value="3.5" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="p-year" class="input-warm" value="7"></div>
                    </div>
                </div>
            </div>

            <!-- è»Šè²¸ -->
            <div class="card-warm p-5 border-t-4 border-orange-600 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-orange-50 opacity-20 text-9xl pointer-events-none rotate-12"><i class="fas fa-car-side"></i></div>
                <h3 class="font-bold text-lg mb-4 text-warm-800 flex items-center"><span class="w-2 h-6 bg-orange-600 rounded-full mr-2"></span>æ±½è»Šè²¸æ¬¾</h3>
                <div class="space-y-4 relative z-10">
                    <div><label class="text-xs text-warm-600 ml-1">è²¸æ¬¾é‡‘é¡ (è¬å…ƒ)</label><input type="number" id="c-amt" class="input-warm" value="0"></div>
                    <div class="flex gap-3">
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">å¹´åˆ©ç‡ (%)</label><input type="number" id="c-rate" class="input-warm" value="4.0" step="0.01"></div>
                        <div class="w-1/2"><label class="text-xs text-warm-600 ml-1">æœŸé™ (å¹´)</label><input type="number" id="c-year" class="input-warm" value="5"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…¨å±€è¨­å®š -->
        <div class="card-warm p-5 bg-warm-50 border border-warm-200 no-print">
            <div class="flex flex-col md:flex-row items-end gap-4">
                <div class="w-full md:w-1/3">
                    <label class="font-bold text-warm-800 text-sm"><i class="fas fa-calendar-alt mr-2"></i>é–‹å§‹é‚„æ¬¾æœˆä»½</label>
                    <input type="month" id="start-month" class="input-warm mt-1" onchange="calculateAll()">
                </div>
                <div class="w-full md:w-1/3">
                    <label class="font-bold text-warm-800 text-sm"><i class="fas fa-wallet mr-2"></i>æœˆæ”¶å…¥ (å…ƒ)</label>
                    <input type="number" id="income" class="input-warm mt-1" value="60000">
                </div>
                <div class="w-full md:w-1/3 bg-white p-3 rounded-xl border border-warm-100 shadow-sm">
                    <div id="dti-msg" class="hidden text-rose-600 text-sm font-bold flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-xl"></i> <div>è² å‚µæ¯”éé«˜ (>60%)</div></div>
                    <div id="dti-ok" class="hidden text-green-700 text-sm font-bold flex items-center"><i class="fas fa-check-circle mr-2 text-xl"></i> è²¡å‹™ç‹€æ³å¥åº·</div>
                </div>
            </div>
        </div>

        <!-- å ±è¡¨ç¸½è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card-warm p-6 flex flex-col items-center justify-center">
                <h4 class="text-warm-600 font-bold mb-4">æœˆä»˜é‡‘çµæ§‹</h4>
                <div class="w-40 h-40 relative">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="mt-4 text-center text-xs text-warm-500" id="pie-legend"></div>
            </div>
            <div class="md:col-span-2 card-warm p-6">
                <h4 class="text-warm-600 font-bold mb-4 border-b border-warm-100 pb-2 flex justify-between">
                    <span>è²¡å‹™é æ¸¬æ‘˜è¦</span>
                    <span class="text-xs font-normal bg-orange-100 text-orange-800 px-2 py-1 rounded" id="saving-badge" style="display:none">ğŸ‰ æå‰é‚„æ¬¾çœæ¯ä¸­</span>
                </h4>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center mb-6">
                    <div class="p-3 bg-orange-50 rounded-xl"><div class="text-xs text-warm-500">é¦–æœˆæ”¯å‡º</div><div class="text-lg font-bold text-accent-house1" id="res-monthly">$0</div></div>
                    <div class="p-3 bg-stone-50 rounded-xl"><div class="text-xs text-warm-500">æ¯å¹´æ”¯å‡º</div><div class="text-lg font-bold text-warm-800" id="res-yearly">$0</div></div>
                    <div class="p-3 bg-stone-50 rounded-xl"><div class="text-xs text-warm-500">ç¸½åˆ©æ¯</div><div class="text-lg font-bold text-warm-600" id="res-interest">$0</div></div>
                    <div class="p-3 bg-lime-50 rounded-xl"><div class="text-xs text-warm-500">è² å‚µæ¯”</div><div class="text-lg font-bold text-accent-credit" id="res-dti">0%</div></div>
                </div>
                <div class="h-48 w-full"><canvas id="scheduleChart"></canvas></div>
            </div>
        </div>

        <!-- è©³ç´°è¡¨æ ¼å€ -->
        <div id="schedule-container" class="space-y-4"></div>

        <!-- é å°¾ -->
        <footer class="text-center text-warm-500 text-sm py-8 print-only-footer">
            <p class="mb-2">ç†è²¡è¦åŠƒãƒ»è²¸æ¬¾è©¦ç®—</p>
            <a href="https://vocus.cc/user/@WUCJ" target="_blank" class="inline-block px-4 py-2 rounded-full bg-white border border-warm-200 hover:bg-warm-50 transition">
                æ›´å¤šæ–‡ç« è«‹è‡³ <strong class="text-accent-house1">WUCJ çš„æ–¹æ ¼å­</strong>
            </a>
            <p class="text-xs mt-4 opacity-60">è¨ˆç®—çµæœåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ä»¥éŠ€è¡Œç‚ºæº–ã€‚</p>
        </footer>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-amber-100 p-4 border-b border-amber-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-amber-800"><i class="fas fa-book-reader mr-2"></i>ä½¿ç”¨æ•™å­¸</h3>
                <button onclick="toggleHelp()" class="text-amber-800 w-8 h-8 rounded-full bg-white/50 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh] space-y-4 text-sm text-warm-800">
                <p><strong>1. é›™æˆ¿è²¸è¨­è¨ˆ</strong>ï¼šæˆ¿è²¸A(ä¸»ç´„)èˆ‡æˆ¿è²¸B(å¢è²¸)å¯åˆ†é–‹è¼¸å…¥ï¼Œé©åˆè½‰å¢è²¸æˆ–äºŒèƒè¦åŠƒã€‚</p>
                <p><strong>2. æå‰é‚„æ¬¾</strong>ï¼šå…©ç­†æˆ¿è²¸çš†å¯ç¨ç«‹è¨­å®šæå‰é‚„æ¬¾ï¼Œå»ºè­°å„ªå…ˆå„Ÿé‚„åˆ©ç‡é«˜çš„ã€‚</p>
                <p><strong>3. è² å‚µæ¯”è­¦ç¤º</strong>ï¼šè¶…é 60% DTI æœƒæœ‰ç´…è‰²æé†’ã€‚</p>
            </div>
        </div>
    </div>

    <!-- Canvas Template -->
    <div id="share-card-canvas">
        <div class="w-full text-center">
            <h1 class="text-6xl font-bold text-warm-800 mb-4">è²¡å‹™è‡ªç”±è—åœ–</h1>
            <p class="text-3xl text-warm-600">MY LOAN PLAN</p>
        </div>
        <div class="w-full bg-white p-10 rounded-[3rem] shadow-lg border-4 border-warm-100">
            <div class="flex justify-between items-end mb-8 border-b-4 border-warm-100 pb-6">
                <span class="text-3xl text-warm-500 font-bold">æ¯æœˆç¾é‡‘æµ</span>
                <span class="text-7xl font-bold text-accent-house1" id="card-monthly">$0</span>
            </div>
             <div class="flex justify-between items-end mb-8 border-b-4 border-warm-100 pb-6">
                <span class="text-3xl text-warm-500 font-bold">é ä¼°ç¸½åˆ©æ¯</span>
                <span class="text-7xl font-bold text-warm-600" id="card-interest">$0</span>
            </div>
            <div class="flex justify-between items-end">
                <span class="text-3xl text-warm-500 font-bold">è² å‚µæ¯”</span>
                <span class="text-7xl font-bold text-accent-credit" id="card-dti">0%</span>
            </div>
        </div>
        <div class="w-full flex justify-between items-center px-4">
            <div class="text-left"><p class="text-3xl text-warm-800 font-bold">ç†è²¡ï¼Œæ˜¯ç‚ºäº†æ›´è‡ªç”±çš„æ˜å¤©ã€‚</p></div>
            <div class="bg-white p-4 rounded-xl shadow-md"><div class="w-32 h-32 bg-warm-200 flex items-center justify-center text-warm-800 font-bold rounded">WUCJ</div></div>
        </div>
    </div>

    <script>
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        document.getElementById('start-month').value = nextMonth.toISOString().slice(0, 7);

        let scheduleChart, pieChart;
        const fmt = (n) => Math.round(n).toLocaleString();

        class Loan {
            constructor(amountWan, rate, years, graceYears = 0, extraPay = {year: 0, amt: 0}) {
                this.principal = amountWan * 10000;
                this.rate = rate / 100 / 12;
                this.periods = years * 12;
                this.gracePeriods = graceYears * 12;
                this.extraPayMonth = extraPay.year * 12;
                this.extraPayAmount = extraPay.amt * 10000;
            }
            getSchedule() {
                let schedule = [];
                let balance = this.principal;
                let pmt = this.calculatePMT(balance, this.periods - this.gracePeriods);
                for (let i = 1; i <= this.periods; i++) {
                    let extraPayment = 0;
                    if (i === this.extraPayMonth && this.extraPayAmount > 0) {
                        balance -= this.extraPayAmount;
                        if (balance < 0) { extraPayment = this.extraPayAmount + balance; balance = 0; } 
                        else { extraPayment = this.extraPayAmount; }
                        let remainingPeriods = this.periods - i;
                        if (remainingPeriods > 0) { pmt = this.calculatePMT(balance, remainingPeriods); } else { pmt = balance; }
                    }
                    let interest = balance * this.rate;
                    let payment = 0;
                    let principalPaid = 0;
                    if (i <= this.gracePeriods) { payment = interest; } 
                    else {
                        payment = pmt;
                        principalPaid = payment - interest;
                        if (balance - principalPaid < 10 || i === this.periods) { principalPaid = balance; payment = principalPaid + interest; }
                    }
                    let totalCashOut = payment + extraPayment;
                    balance -= principalPaid;
                    if (balance < 0) balance = 0;
                    schedule.push({ month: i, payment: totalCashOut, interest: interest, principal: principalPaid, balance: balance, isExtra: extraPayment > 0 });
                    if (balance <= 0 && extraPayment === 0) break;
                }
                return schedule;
            }
            calculatePMT(p, n) {
                if (n <= 0) return 0;
                if (this.rate === 0) return p / n;
                return (p * this.rate * Math.pow(1 + this.rate, n)) / (Math.pow(1 + this.rate, n) - 1);
            }
        }

        function togglePrepay(type) {
            const box = document.getElementById(`prepay-box-${type}`);
            const icon = document.getElementById(`prepay-icon-${type}`);
            if (box.classList.contains('hidden')) { box.classList.remove('hidden'); icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); } 
            else { box.classList.add('hidden'); icon.classList.add('fa-chevron-down'); icon.classList.remove('fa-chevron-up'); }
        }
        function toggleHelp() { document.getElementById('help-modal').classList.toggle('hidden'); }

        function calculateAll() {
            const inputs = {
                h: { amt: +document.getElementById('h-amt').value, rate: +document.getElementById('h-rate').value, yr: +document.getElementById('h-year').value, grace: +document.getElementById('h-grace').value },
                h2: { amt: +document.getElementById('h2-amt').value, rate: +document.getElementById('h2-rate').value, yr: +document.getElementById('h2-year').value, grace: +document.getElementById('h2-grace').value },
                pre: { yr: +document.getElementById('h-pre-yr').value, amt: +document.getElementById('h-pre-amt').value },
                pre2: { yr: +document.getElementById('h2-pre-yr').value, amt: +document.getElementById('h2-pre-amt').value },
                p: { amt: +document.getElementById('p-amt').value, rate: +document.getElementById('p-rate').value, yr: +document.getElementById('p-year').value },
                c: { amt: +document.getElementById('c-amt').value, rate: +document.getElementById('c-rate').value, yr: +document.getElementById('c-year').value },
                income: +document.getElementById('income').value,
                startMonth: document.getElementById('start-month').value
            };
            saveToLocal();
            document.getElementById('saving-badge').style.display = ((inputs.pre.yr > 0 && inputs.pre.amt > 0) || (inputs.pre2.yr > 0 && inputs.pre2.amt > 0)) ? 'block' : 'none';

            const sH = new Loan(inputs.h.amt, inputs.h.rate, inputs.h.yr, inputs.h.grace, {year: inputs.pre.yr, amt: inputs.pre.amt}).getSchedule();
            const sH2 = new Loan(inputs.h2.amt, inputs.h2.rate, inputs.h2.yr, inputs.h2.grace, {year: inputs.pre2.yr, amt: inputs.pre2.amt}).getSchedule();
            const sP = new Loan(inputs.p.amt, inputs.p.rate, inputs.p.yr).getSchedule();
            const sC = new Loan(inputs.c.amt, inputs.c.rate, inputs.c.yr).getSchedule();

            const maxMonths = Math.max(sH.length, sH2.length, sP.length, sC.length);
            let combined = [];
            let totalInterest = 0;
            let [startYear, startM] = inputs.startMonth.split('-').map(Number);
            startM -= 1;

            for (let i = 0; i < maxMonths; i++) {
                const h = sH[i] || { payment: 0, interest: 0, principal: 0, balance: 0, isExtra: false };
                const h2 = sH2[i] || { payment: 0, interest: 0, principal: 0, balance: 0, isExtra: false };
                const p = sP[i] || { payment: 0, interest: 0, principal: 0, balance: 0 };
                const c = sC[i] || { payment: 0, interest: 0, principal: 0, balance: 0 };

                let currentD = new Date(startYear, startM + i, 1);
                let dateStr = `${currentD.getFullYear()}/${(currentD.getMonth() + 1).toString().padStart(2, '0')}`;
                let rowPay = h.payment + h2.payment + p.payment + c.payment;
                let rowInt = h.interest + h2.interest + p.interest + c.interest;
                let rowPrin = h.principal + h2.principal + p.principal + c.principal;
                let rowBal = h.balance + h2.balance + p.balance + c.balance;

                totalInterest += rowInt;
                combined.push({ idx: i+1, date: dateStr, payment: rowPay, interest: rowInt, principal: rowPrin, balance: rowBal, isExtra: (h.isExtra || h2.isExtra) });
            }

            const first = combined[0]?.payment || 0;
            document.getElementById('res-monthly').innerText = '$' + fmt(first);
            document.getElementById('res-yearly').innerText = '$' + fmt(first * 12);
            document.getElementById('res-interest').innerText = '$' + fmt(totalInterest);
            document.getElementById('card-monthly').innerText = '$' + fmt(first);
            document.getElementById('card-interest').innerText = '$' + fmt(totalInterest);

            const dti = inputs.income > 0 ? (first / inputs.income * 100) : 0;
            document.getElementById('res-dti').innerText = dti.toFixed(1) + '%';
            document.getElementById('card-dti').innerText = dti.toFixed(1) + '%';
            
            if(dti > 60) {
                document.getElementById('dti-msg').classList.remove('hidden');
                document.getElementById('dti-ok').classList.add('hidden');
                document.getElementById('res-dti').classList.add('text-rose-600');
            } else {
                document.getElementById('dti-msg').classList.add('hidden');
                document.getElementById('dti-ok').classList.remove('hidden');
                document.getElementById('res-dti').classList.remove('text-rose-600');
            }
            renderPagedTable(combined);
            updateCharts(combined, (sH[0]?.payment||0), (sH2[0]?.payment||0), (sP[0]?.payment||0), (sC[0]?.payment||0));
        }

        function renderPagedTable(data) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            const pageSize = 120;
            const totalPages = Math.ceil(data.length / pageSize);

            if (totalPages > 1) {
                const tabContainer = document.createElement('div');
                tabContainer.className = 'flex gap-2 pb-2 overflow-x-auto no-print';
                for (let i = 0; i < totalPages; i++) {
                    const btn = document.createElement('button');
                    const startY = i * 10 + 1;
                    const endY = Math.min((i + 1) * 10, Math.ceil(data.length/12));
                    btn.className = `btn-soft text-xs ${i === 0 ? 'active' : ''}`;
                    btn.innerText = `ç¬¬ ${startY}-${endY} å¹´`;
                    btn.onclick = (e) => { 
                        switchTab(i); 
                        document.querySelectorAll('.btn-soft').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    };
                    tabContainer.appendChild(btn);
                }
                container.appendChild(tabContainer);
            }

            for (let i = 0; i < totalPages; i++) {
                const pageData = data.slice(i * pageSize, (i + 1) * pageSize);
                const pageDiv = document.createElement('div');
                pageDiv.className = `table-page card-warm overflow-hidden ${i === 0 ? '' : 'hidden'}`;
                pageDiv.id = `page-${i}`;
                const startY = i * 10 + 1;
                const endY = Math.min((i + 1) * 10, Math.ceil(data.length/12));
                pageDiv.innerHTML = `
                    <div class="p-4 bg-warm-100 border-b border-warm-200 flex justify-between items-center">
                        <h3 class="font-bold text-warm-800 text-sm"><i class="fas fa-calendar-week mr-2"></i>é‚„æ¬¾æ˜ç´° (ç¬¬ ${startY} - ${endY} å¹´)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="bg-warm-50 text-warm-600"><tr><th class="p-3 pl-4">æœŸæ•¸</th><th class="p-3">æœˆä»½</th><th class="p-3 text-right">æœ¬æœˆæ”¯å‡º</th><th class="p-3 text-right text-warm-400">åˆ©æ¯</th><th class="p-3 text-right text-warm-400">æœ¬é‡‘</th><th class="p-3 text-right pr-4">å‰©é¤˜æœ¬é‡‘</th></tr></thead>
                            <tbody class="divide-y divide-warm-100 text-warm-700">
                                ${pageData.map(row => `<tr class="${row.isExtra ? 'bg-amber-100' : 'hover:bg-orange-50'} transition"><td class="p-3 pl-4">${row.idx}</td><td class="p-3 font-mono">${row.date}</td><td class="p-3 text-right font-bold text-warm-800">$${fmt(row.payment)}${row.isExtra?'<span class="text-[10px] block text-amber-600">(å«æå‰é‚„æ¬¾)</span>':''}</td><td class="p-3 text-right text-xs text-warm-500">$${fmt(row.interest)}</td><td class="p-3 text-right text-xs text-warm-500">$${fmt(row.principal)}</td><td class="p-3 text-right pr-4 text-warm-400">$${fmt(row.balance)}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(pageDiv);
            }
        }

        function switchTab(idx) { document.querySelectorAll('.table-page').forEach((p, i) => { p.classList.toggle('hidden', i !== idx); }); }

        function updateCharts(data, h, h2, p, c) {
            let labels = [], dataset = [];
            for(let i=0; i<data.length; i+=12) { labels.push(`ç¬¬${Math.ceil((i+1)/12)}å¹´`); dataset.push(data[i].payment); }
            if(scheduleChart) scheduleChart.destroy();
            if(pieChart) pieChart.destroy();
            scheduleChart = new Chart(document.getElementById('scheduleChart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'æœˆæ”¯å‡º', data: dataset, borderColor: '#8C7051', backgroundColor: 'rgba(140, 112, 81, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: { labels: ['æˆ¿è²¸A', 'æˆ¿è²¸B', 'ä¿¡è²¸', 'è»Šè²¸'], datasets: [{ data: [h, h2, p, c], backgroundColor: ['#D97706', '#9333EA', '#65A30D', '#EA580C'], borderWidth: 0 }] },
                options: { cutout: '60%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            document.getElementById('pie-legend').innerHTML = `<span class="text-accent-house1">â— A $${fmt(h)}</span> <span class="text-accent-house2 ml-1">â— B $${fmt(h2)}</span> <span class="text-accent-credit ml-1">â— ä¿¡ $${fmt(p)}</span> <span class="text-accent-car ml-1">â— è»Š $${fmt(c)}</span>`;
        }

        function saveToLocal() {
            const data = {
                h: { amt: document.getElementById('h-amt').value, rate: document.getElementById('h-rate').value, yr: document.getElementById('h-year').value, grace: document.getElementById('h-grace').value },
                h2: { amt: document.getElementById('h2-amt').value, rate: document.getElementById('h2-rate').value, yr: document.getElementById('h2-year').value, grace: document.getElementById('h2-grace').value },
                pre: { yr: document.getElementById('h-pre-yr').value, amt: document.getElementById('h-pre-amt').value },
                pre2: { yr: document.getElementById('h2-pre-yr').value, amt: document.getElementById('h2-pre-amt').value },
                p: { amt: document.getElementById('p-amt').value, rate: document.getElementById('p-rate').value, yr: document.getElementById('p-year').value },
                c: { amt: document.getElementById('c-amt').value, rate: document.getElementById('c-rate').value, yr: document.getElementById('c-year').value },
                income: document.getElementById('income').value,
                startMonth: document.getElementById('start-month').value
            };
            localStorage.setItem('wucj_loan_data_v2', JSON.stringify(data));
            const toast = document.getElementById('auto-save-toast'); toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000);
        }

        function loadFromLocal() {
            const raw = localStorage.getItem('wucj_loan_data_v2'); if (!raw) return;
            try {
                const d = JSON.parse(raw);
                if(d.h) { document.getElementById('h-amt').value = d.h.amt; document.getElementById('h-rate').value = d.h.rate; document.getElementById('h-year').value = d.h.yr; document.getElementById('h-grace').value = d.h.grace; }
                if(d.h2) { document.getElementById('h2-amt').value = d.h2.amt; document.getElementById('h2-rate').value = d.h2.rate; document.getElementById('h2-year').value = d.h2.yr; document.getElementById('h2-grace').value = d.h2.grace; }
                if(d.pre) { document.getElementById('h-pre-yr').value = d.pre.yr; document.getElementById('h-pre-amt').value = d.pre.amt; }
                if(d.pre2) { document.getElementById('h2-pre-yr').value = d.pre2.yr; document.getElementById('h2-pre-amt').value = d.pre2.amt; }
                if(d.p) { document.getElementById('p-amt').value = d.p.amt; document.getElementById('p-rate').value = d.p.rate; document.getElementById('p-year').value = d.p.yr; }
                if(d.c) { document.getElementById('c-amt').value = d.c.amt; document.getElementById('c-rate').value = d.c.rate; document.getElementById('c-year').value = d.c.yr; }
                if(d.income) document.getElementById('income').value = d.income;
                if(d.startMonth) document.getElementById('start-month').value = d.startMonth;
            } catch(e) {}
        }

        function generateShareCard() { window.scrollTo(0, 0); const card = document.getElementById('share-card-canvas'); html2canvas(card, { scale: 1 }).then(canvas => { const link = document.createElement('a'); link.download = 'WUCJ_Finance_Plan.png'; link.href = canvas.toDataURL(); link.click(); }); }
        function exportData() { const raw = localStorage.getItem('wucj_loan_data_v2'); if(!raw) { alert('å°šç„¡è³‡æ–™å¯å„²å­˜'); return; } const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([raw], {type: "application/json"})); a.download = "loan_backup_wucj.json"; a.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const r = new FileReader(); r.onload = (e) => { localStorage.setItem('wucj_loan_data_v2', e.target.result); loadFromLocal(); calculateAll(); alert('è®€å–æˆåŠŸï¼'); }; r.readAsText(file); }

        document.querySelectorAll('input').forEach(el => el.addEventListener('input', calculateAll));
        window.onload = function() { loadFromLocal(); calculateAll(); }
    </script>
</body>
</html>
